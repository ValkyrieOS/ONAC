<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard de Clanes ONAC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap");
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Poppins", "sans-serif"],
            },
            colors: {
              "onac-blue": "#3B82F6",
              "onac-dark": "#1E293B",
              "onac-light": "#F3F4F6",
              "onac-orange": "#D97706",
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="bg-onac-dark text-onac-light min-h-screen flex flex-col font-sans"
  >
    <header class="bg-gray-800 text-white py-6 sticky top-0 z-10 shadow-lg">
      <div class="container mx-auto px-4">
        <div class="flex justify-between items-center">
          <h1 class="text-3xl font-bold text-onac-blue">ONAC</h1>
          <nav>
            <ul class="flex space-x-6">
              <li>
                <a
                  href="index.html"
                  class="hover:text-onac-blue transition-colors duration-200 text-lg"
                  >Inicio</a
                >
              </li>
              <li>
                <a
                  href="members.html"
                  class="hover:text-onac-blue transition-colors duration-200 text-lg"
                  >Miembros</a
                >
              </li>
              <li>
                <a
                  href="balance.html"
                  class="hover:text-onac-blue font-semibold transition-colors duration-200 text-lg"
                  >Balance</a
                >
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-12">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 mb-12">
        <div class="lg:col-span-3">
          <h2 class="text-3xl font-semibold mb-6 text-onac-blue">
            Resumen de Clanes
          </h2>
          <div id="clanSummary" class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <!-- El resumen de clanes se insertará aquí -->
          </div>
        </div>
        <div class="lg:col-span-1">
          <button
            id="sendWebhook"
            class="w-full bg-onac-blue hover:bg-blue-600 text-white font-bold py-4 px-6 rounded-lg shadow-lg transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 mb-6 flex items-center justify-center"
          >
            <i class="fab fa-discord mr-2"></i> Enviar Resumen a Discord
          </button>
          <div id="lastUpdate" class="text-center text-gray-400"></div>
        </div>
      </div>

      <div id="clanStatus" class="grid grid-cols-1 lg:grid-cols-4 gap-8">
        <!-- Los estados de los clanes se insertarán aquí -->
      </div>
    </main>

    <footer class="bg-onac-dark text-center py-6 border-t border-gray-800">
      <p class="text-sm text-gray-400">
        © 2024 ONAC - Organización de NauticMC para la Ayuda y el Crecimiento
      </p>
    </footer>

    <script>
      const webhookUrl =
        "https://discord.com/api/webhooks/1303277531222511658/cR4CwJXYx6MiSda-0hvemrDikUaiVC68s2mRLMkryaRkdmEmd2_5wa8U_uZOE2i0oZQ4";

      async function fetchMembers() {
        try {
          const response = await fetch("data/members.json");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          console.log("Datos cargados:", data);
          return data.members;
        } catch (error) {
          console.error("Error al cargar los miembros:", error);
          return [];
        }
      }

      function createClanSummaryCard(status, count) {
        const statusColors = {
          activo: "bg-green-500",
          pendiente: "bg-yellow-500",
          baneado: "bg-red-500",
          inhabilitado: "bg-onac-orange",
        };

        const statusIcons = {
          activo: "fa-check-circle",
          pendiente: "fa-clock",
          baneado: "fa-ban",
          inhabilitado: "fa-exclamation-triangle",
        };

        const card = document.createElement("div");
        card.className = `${statusColors[status]} rounded-lg overflow-hidden shadow-lg p-6 transform transition-all duration-300 hover:scale-105`;

        const title = status.charAt(0).toUpperCase() + status.slice(1);

        card.innerHTML = `
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold">${title}s</h3>
                    <i class="fas ${statusIcons[status]} text-4xl"></i>
                </div>
                <p class="text-5xl font-bold mt-4">${count}</p>
            `;

        return card;
      }

      function calculateDaysRemaining(fechaReactivacion) {
        if (fechaReactivacion === "indefinido") {
          return "Indefinido";
        }
        const today = new Date();
        const reactivationDate = new Date(fechaReactivacion);
        const timeDiff = reactivationDate.getTime() - today.getTime();
        const daysRemaining = Math.ceil(timeDiff / (1000 * 3600 * 24));
        return daysRemaining > 0 ? daysRemaining : 0;
      }

      function createClanStatusCard(status, members) {
        const statusColors = {
          activo: "bg-green-500",
          pendiente: "bg-yellow-500",
          baneado: "bg-red-500",
          inhabilitado: "bg-onac-orange",
        };

        const statusIcons = {
          activo: "fa-check-circle",
          pendiente: "fa-clock",
          baneado: "fa-ban",
          inhabilitado: "fa-exclamation-triangle",
        };

        const card = document.createElement("div");
        card.className = `${statusColors[status]} rounded-lg overflow-hidden shadow-lg`;

        const title = status.charAt(0).toUpperCase() + status.slice(1);
        const count = members.length;

        card.innerHTML = `
                <div class="p-6">
                    <h2 class="text-3xl font-bold mb-6 flex items-center justify-between">
                        <span>Clanes ${title}s</span>
                        <i class="fas ${statusIcons[status]} text-4xl"></i>
                    </h2>
                    <ul class="space-y-6">
                        ${members
                          .map(
                            (member) => `
                            <li class="bg-black bg-opacity-20 p-4 rounded-lg flex items-center space-x-4 transform transition-all duration-300 hover:scale-105">
                                <img src="${member.image}" alt="${
                              member.name
                            }" class="w-16 h-16 rounded-full object-cover border-2 border-white">
                                <div class="flex-grow">
                                    <h3 class="text-xl font-semibold">${
                                      member.name
                                    }</h3>
                                    <p class="text-sm opacity-75">${
                                      member.role
                                    }</p>
                                    ${
                                      member.motivo
                                        ? `<p class="text-sm text-red-300 mt-1">Motivo: ${member.motivo}</p>`
                                        : ""
                                    }
                                    ${
                                      member.fechaReactivacion
                                        ? `<p class="text-sm text-green-300 mt-1">
                                            Fecha de reactivación: ${
                                              member.fechaReactivacion ===
                                              "indefinido"
                                                ? "Indefinido"
                                                : new Date(
                                                    member.fechaReactivacion
                                                  ).toLocaleDateString()
                                            }
                                            ${
                                              member.fechaReactivacion !==
                                              "indefinido"
                                                ? `(${calculateDaysRemaining(
                                                    member.fechaReactivacion
                                                  )} días restantes)`
                                                : ""
                                            }
                                        </p>`
                                        : ""
                                    }
                                </div>
                            </li>
                        `
                          )
                          .join("")}
                    </ul>
                </div>
            `;

        return card;
      }

      async function updateDashboard() {
        const members = await fetchMembers();
        console.log("Miembros obtenidos:", members);
        const clanStatusContainer = document.getElementById("clanStatus");
        const clanSummaryContainer = document.getElementById("clanSummary");

        if (!clanStatusContainer || !clanSummaryContainer) {
          console.error("No se encontraron los contenedores necesarios");
          return;
        }

        clanStatusContainer.innerHTML = "";
        clanSummaryContainer.innerHTML = "";

        const statuses = ["activo", "pendiente", "baneado", "inhabilitado"];
        statuses.forEach((status) => {
          const membersOfStatus = members.filter(
            (member) => member.status === status
          );
          console.log(`Miembros ${status}:`, membersOfStatus);
          if (membersOfStatus.length > 0) {
            const summaryCard = createClanSummaryCard(
              status,
              membersOfStatus.length
            );
            clanSummaryContainer.appendChild(summaryCard);

            const statusCard = createClanStatusCard(status, membersOfStatus);
            clanStatusContainer.appendChild(statusCard);
          }
        });

        document.getElementById(
          "lastUpdate"
        ).innerHTML = `<i class="fas fa-sync-alt mr-2"></i>Última actualización: ${new Date().toLocaleString()}`;
      }

      async function sendWebhook() {
        const members = await fetchMembers();
        const activos = members.filter((m) => m.status === "activo");
        const pendientes = members.filter((m) => m.status === "pendiente");
        const baneados = members.filter((m) => m.status === "baneado");
        const inhabilitados = members.filter(
          (m) => m.status === "inhabilitado"
        );

        const message = {
          content: "📊 Estado actual de los clanes ONAC:",
          embeds: [
            {
              title: "Resumen de Clanes",
              color: 3447003,
              fields: [
                {
                  name: "✅ Clanes Activos",
                  value: `Total: ${activos.length}\n${activos
                    .map((m) => `• ${m.name}`)
                    .join("\n")}`,
                  inline: false,
                },
                {
                  name: "⏳ Clanes Pendientes",
                  value: `Total: ${pendientes.length}\n${pendientes
                    .map((m) => `• ${m.name}`)
                    .join("\n")}`,
                  inline: false,
                },
                {
                  name: "🚫 Clanes Baneados",
                  value: `Total: ${baneados.length}\n${baneados
                    .map((m) => `• ${m.name} (Motivo: ${m.motivo})`)
                    .join("\n")}`,
                  inline: false,
                },
                {
                  name: "⚠️ Clanes Inhabilitados",
                  value: `Total: ${inhabilitados.length}\n${inhabilitados
                    .map((m) => {
                      const daysRemaining = calculateDaysRemaining(
                        m.fechaReactivacion
                      );
                      return `• ${m.name} (Motivo: ${m.motivo}, Reactivación: ${
                        m.fechaReactivacion === "indefinido"
                          ? "Indefinido"
                          : `${new Date(
                              m.fechaReactivacion
                            ).toLocaleDateString()} (${daysRemaining} días restantes)`
                      })`;
                    })
                    .join("\n")}`,
                  inline: false,
                },
              ],
              timestamp: new Date().toISOString(),
              footer: {
                text: "ONAC - Organización de NauticMC para la Ayuda y el Crecimiento",
              },
            },
          ],
        };

        try {
          const response = await fetch(webhookUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(message),
          });

          if (response.ok) {
            alert("Resumen enviado con éxito a Discord!");
          } else {
            throw new Error("Error al enviar el resumen");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al enviar el resumen a Discord");
        }
      }

      document
        .getElementById("sendWebhook")
        .addEventListener("click", sendWebhook);

      // Actualizar el dashboard al cargar la página y cada 5 minutos
      document.addEventListener("DOMContentLoaded", () => {
        updateDashboard();
        setInterval(updateDashboard, 300000);
      });
    </script>
  </body>
</html>
